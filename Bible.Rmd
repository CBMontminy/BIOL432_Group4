---
title: "Bible 2.0"
author: "Marin H"
date: "2023-03-23"
output:
  pdf_document: default
  html_document: default
---



Instructions
1. Create count matrix (use genes)
2. Sum each count for each row 
3. Divide each cell in the row by row sum 
4. Multiply each cell by constant (ex: max number of reads across all rows)
5. Perform NMDS
6. Cluster by treatment.  

## Loading packages
```{r, echo=F}
library(tidyr)
library(dplyr)
library(ggplot2)
```

## Loading Data
```{r}
Data=read.csv("CombinedData.csv")
Data=select(Data, c("gene", "treatment_id", "abundance_log2"))
names(Data)=c("Gene", "Treatment", "Abundance")
```


# Averaging replicates (Gene under same treatment)
```{r}
AvgDat= Data %>%
  group_by(Gene, Treatment) %>%
  summarize(AvgCount=mean(Abundance))
AvgDat$AvgCount=round(AvgDat$AvgCount)
```


# Convert to count matrix
## Reshape dataframe to have genes as rows and treatments as columns
```{r}
WideDat=AvgDat %>%
  pivot_wider(names_from="Treatment", values_from="AvgCount")
```

# Seperate out character and numeric data
```{r}
# Create all numeric data frame
NumericData <- as.data.frame(WideDat[,2:7])
row.names(NumericData) <-  WideDat$Gene # keep unique identifiers
```


# Genereate distance matrix
```{r}
library(vegan) # load vegdist()

# create dissimilarity matrix
DistanceMatrix <- vegdist(NumericData, method="bray", binary=F)
```

# Run NMDS
```{r}
set.seed(39)
NMDSdat <- metaMDS(DistanceMatrix, k=2, trymax = 10) # need to change 10 to a higher number, but keep low for testing
```

# Select relevant columns 
```{r}
Plot_NMDS <- data.frame(NMDS1 = NMDSdat$points[,1],
                   NMDS2 = NMDSdat$points[,2],
                   Gene = row.names(NumericData))
```

# Add labels using merge function
```{r}
Plot_NMDS <- merge(Plot_NMDS, AvgDat, by = "Gene", all.x=T, all.y=F)
```

# Plot NMDS results 
```{r}
ggplot(Plot_NMDS, aes(x = NMDS1, y = NMDS2, colour=Treatment)) +
  geom_jitter(width = 0.001, height = 0.001)+
  theme(legend.position="right")+ theme_classic()
```
# Converting to select by gene instead of treatment
```{r}
TNumDat=t(NumericData)
```

# Creating distance Matrix from transposed data
```{r}
TDistanceMatrix = vegdist(TNumDat, method="bray", binary=F)
```


# Run NMDS
```{r}
set.seed(39)
TNMDSdat <- metaMDS(TDistanceMatrix, k=2, trymax = 10) # need to change 10 to a higher number, but keep low for testing
```

# Select relevant columns 
```{r}
TPlot_NMDS <- data.frame(NMDS1 = TNMDSdat$points[,1],
                   NMDS2 = TNMDSdat$points[,2],
                   Treatment = row.names(TNumDat))
```

# Add labels using merge function
```{r}
TPlot_NMDS <- merge(TPlot_NMDS, AvgDat, by = "Treatment", all.x=T, all.y=F)
```

# Plot NMDS results 
```{r}
ggplot(TPlot_NMDS, aes(x = NMDS1, y = NMDS2, colour=Treatment)) +
  geom_jitter(width = 0.001, height = 0.001, alpha=0.5, shape=3) +
  theme(legend.position="right")+
  theme_classic()
```



